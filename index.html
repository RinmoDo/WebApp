<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Achat & Suivi des dossiers</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="src/style.css">
  <style>
    /* Login-specific small styles merged from login.html */
    body.login-page{background:#f5f7fb}
    .auth-card{max-width:420px;border-radius:1rem}
    .brand{font-weight:700;letter-spacing:.2px}
    .logo{height:40px;width:auto}
    .form-floating>label{color:#6c757d}
    .invalid-feedback{display:block}
  </style>
</head>
<body>
  <!-- Login overlay / initial screen -->
  <div id="loginScreen" class="login-screen">
    <nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom shadow-sm">
      <div class="container d-flex align-items-center justify-content-between">
        <a class="navbar-brand d-flex align-items-center gap-3" href="#">
          <img src="img/logo.png" alt="logo" style="height:36px;width:auto">
          <div class="d-flex flex-column">
            <span class="fw-semibold">Achat &amp; Suivi</span>
              <small class="text-muted">ONEE-BE • Centrale Diesel DAKHLA</small>
          </div>
        </a>
      </div>
    </nav>

    <main class="container d-flex justify-content-center align-items-center" style="min-height:calc(100vh - 72px)">
      <div class="card shadow-sm auth-card w-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center gap-2 mb-3">
            <img class="logo" src="img/logo.png" alt="logo">
            <div class="brand">Achat &amp; Suivi — Connexion</div>
          </div>

          <div id="authAlert" class="alert alert-danger d-none" role="alert"></div>

          <form id="loginForm" novalidate>
            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="username" placeholder="Utilisateur" autocomplete="username" required autofocus>
              <label for="username">Utilisateur</label>
                <div class="invalid-feedback">Nom d’utilisateur requis</div>
            </div>
            <div class="form-floating mb-2 position-relative">
              <input type="password" class="form-control" id="password" placeholder="Mot de passe" autocomplete="current-password" required>
              <label for="password">Mot de passe</label>
              <button type="button" class="btn btn-sm btn-outline-secondary position-absolute" id="togglePwd" style="right:.5rem; top:.5rem">Afficher</button>
              <div class="invalid-feedback">Mot de passe requis</div>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="rememberMe">
                <label class="form-check-label" for="rememberMe">Se souvenir de moi</label>
              </div>
                <a class="small text-decoration-none" href="#" id="resetHelp">Besoin d’aide ?</a>
            </div>
            <button class="btn btn-primary w-100" id="btnLogin" type="submit">Se connecter</button>
            <div class="text-center mt-3 small text-muted" id="lockHint"></div>
          </form>

          <hr class="my-4">
          <div class="small">
            <strong>Comptes de test</strong><br>
            Admin: <code>admin</code> / <code>admin123</code><br>
            Lecteur: <code>viewer</code> / <code>view123</code>
          </div>
        </div>
      </div>
    </main>
  </div>
  <nav id="mainNav" class="navbar navbar-expand-lg bg-body-tertiary border-bottom shadow-sm d-none">
  <div class="container d-flex align-items-center justify-content-between">
    <a class="navbar-brand d-flex align-items-center gap-3" href="#">
      <img src="img/logo.png" alt="logo" style="height:36px;width:auto">
      <div class="d-flex flex-column">
        <span class="fw-semibold">Achat &amp; Suivi</span>
        <small class="text-muted">ONEE-BE • Centrale Diesel DAKHLA</small>
      </div>
    </a>
    <div class="d-flex align-items-center gap-3">
      <span class="small text-muted">Connecté&nbsp;: <strong id="userMenuName">–</strong></span>
      <span id="roleBadge" class="badge bg-secondary badge-role d-none"></span>
      <button class="btn btn-sm btn-outline-secondary d-none" id="btnLogout">Déconnexion</button>
    </div>
  </div>
</nav>

<main class="container my-4">

  <!-- APP -->
  <section id="app" class="app-shell d-none">
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item role-admin-only" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabDash" type="button">Dashboard</button></li>
      <li class="nav-item role-admin-only" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabOT" type="button">Budget de fonctionnement (OT)</button></li>
      <li class="nav-item role-admin-only" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabOI" type="button">Budget d’investissement (OI)</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLaunch" type="button">PPA</button></li>
  <!-- Dossiers en réalisation tab removed -->
    </ul>

    <div class="tab-content border-start border-end border-bottom p-3 bg-white shadow-sm">

      <!-- DASHBOARD -->
      <div id="tabDash" class="tab-pane fade show active role-admin-only">
        <header class="container py-3"><h2 class="mb-0">Tableau de bord</h2></header>
          <section id="dashboard" class="container mb-4">
            <div class="row g-3">
              <div class="col-12 col-md-6 col-xl-3">
                <div class="card shadow-sm h-100"><div class="card-body">
                  <div class="small text-muted">OT — Total 2024</div>
                  <div class="fs-4 fw-bold" id="kpi-ot-total">–</div>
                  <div class="progress mt-2" style="height:6px"><div class="progress-bar" id="kpi-ot-progress" style="width:0%"></div></div>
                </div></div>
              </div>
              <div class="col-12 col-md-6 col-xl-3">
                <div class="card shadow-sm h-100"><div class="card-body">
                  <div class="small text-muted">OT — Taux réalisation 2024</div>
                  <div class="fs-4 fw-bold" id="kpi-ot-taux">–</div>
                </div></div>
              </div>
              <div class="col-12 col-md-6 col-xl-3">
                <div class="card shadow-sm h-100"><div class="card-body">
                  <div class="small text-muted">OI — Budget (Coût) vs Réalisé cumulé</div>
                  <div class="fs-4 fw-bold" id="kpi-oi-variance">–</div>
                  <div class="small text-muted" id="kpi-oi-sub">–</div>
                </div></div>
              </div>
              <div class="col-12 col-md-6 col-xl-3">
                <div class="card shadow-sm h-100"><div class="card-body">
                  <div class="small text-muted">Projets OI actifs</div>
                  <div class="fs-4 fw-bold" id="kpi-oi-count">–</div>
                </div></div>
              </div>
            </div>
            <div class="row g-3 mt-1">
              <div class="col-12 col-md-4">
                <div class="card shadow-sm h-100"><div class="card-body">
                  <div class="small text-muted">Nombre d'OT chargés</div>
                  <div class="fs-4 fw-bold" id="dashOtCount">–</div>
                </div></div>
              </div>
              <div class="col-12 col-md-4">
                <div class="card shadow-sm h-100"><div class="card-body">
                  <div class="small text-muted">Nombre de projets OI</div>
                  <div class="fs-4 fw-bold" id="dashOiCount">–</div>
                </div></div>
              </div>
              <div class="col-12 col-md-4">
                <div class="card shadow-sm h-100"><div class="card-body">
                  <div class="small text-muted">Dossiers PPA suivis</div>
                  <div class="fs-4 fw-bold" id="dashPpaCount">–</div>
                </div></div>
              </div>
            </div>
            <div class="row g-3 mt-1">
              <div class="col-12 col-lg-6">
                <div class="card shadow-sm h-100">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Top 5 OT par budget</span>
                    <small class="text-muted" id="dashOtTotal">–</small>
                  </div>
                  <div class="card-body">
                    <div id="dashOtTop" class="small text-muted">Importez un fichier OT pour afficher les plus importants budgets.</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-lg-6">
                <div class="card shadow-sm h-100">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Top 5 OI par budget</span>
                    <small class="text-muted" id="dashOiTotal">–</small>
                  </div>
                  <div class="card-body">
                    <div id="dashOiTop" class="small text-muted">Importez un fichier OI pour afficher les plus importants budgets.</div>
                  </div>
                </div>
              </div>
            </div>
          </section>
      </div>

      <!-- OI -->
      <div id="tabOI" class="tab-pane fade role-admin-only">
        <div class="d-flex align-items-center mb-3">
          <h5 class="m-0">Budget OI — Données locales : <span id="oiYear"></span></h5>
          <div class="ms-auto d-flex gap-2">
            <button id="btnSave-oi" class="btn btn-primary btn-sm" disabled><i class="bi bi-save me-1"></i>Enregistrer</button>
            <div id="status-oi" class="text-muted small ms-2"></div>
          </div>
        </div>
        <!-- OI upload card -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <button id="pickDir-oi" class="btn btn-primary btn-sm"><i class="bi bi-folder2-open me-1"></i>Choisir/Importer</button>
              <input id="fileInput-oi" type="file" accept=".xlsx" hidden>
            </div>
          </div>
        </div>

        <!-- OI budget section Filtre -->
        <div class="container my-4" id="oi-budget">
          <h3 class="mb-3">Budget d’investissement (OI)</h3>
          <div class="row g-3 mb-3">
            <div class="col-12 col-sm-6 col-lg-3">
              <div class="card shadow-sm h-100"><div class="card-body">
                <div class="small text-muted">OI chargés</div>
                <div class="fs-5 fw-semibold" id="oiCount">–</div>
              </div></div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
              <div class="card shadow-sm h-100"><div class="card-body">
                <div class="small text-muted">Budget total</div>
                <div class="fs-5 fw-semibold" id="oiSum">–</div>
              </div></div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
              <div class="card shadow-sm h-100"><div class="card-body">
                <div class="small text-muted" id="oiYearLabel">Année en cours</div>
                <div class="fs-6" id="oiPct">–</div>
              </div></div>
            </div>
          </div>
          <div class="d-flex gap-2 flex-wrap mb-2">
            <select id="oiFilter" class="form-select" style="max-width:220px">
              <option value="">— Toutes les catégories —</option>
            </select>
            <input id="oiSearch" class="form-control" placeholder="Rechercher description…" style="max-width:320px"/>
          </div>
          <div class="table-responsive"><table class="table table-sm table-striped align-middle" id="oiBudgetTable">
            <thead></thead>
            <tbody></tbody>
            <tfoot></tfoot>
          </table></div>
        </div>

        <div class="table-responsive">
          <table class="table table-striped align-middle" id="tblOI">
            <thead class="table-light">
              <tr>
                <th>N° DI</th><th>N° action</th><th>Désignation</th><th>Estimation</th>
                <th>Année 2025</th><th>Année 2026</th><th>Année 2027</th><th>Base d’estimation</th><th>N° commande</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- OT -->
      <div id="tabOT" class="tab-pane fade role-admin-only">

        <div class="d-flex align-items-center mb-3">
          <h5 class="m-0">Budget OT — Données locales : <span id="otYear"></span></h5>
          <div class="ms-auto d-flex gap-2">
            <button id="btnSave-ot" class="btn btn-primary btn-sm" disabled><i class="bi bi-save me-1"></i>Enregistrer</button>
            <div id="status-ot" class="text-muted small ms-2"></div>
          </div>
        </div>

        <!-- OT upload card -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <button id="pickDir-ot" class="btn btn-primary btn-sm"><i class="bi bi-folder2-open me-1"></i>Choisir/Importer</button>
              <input id="fileInput-ot" type="file" accept=".xlsx" hidden>
            </div>
          </div>
        </div>

        <!-- OT budget section Filtre -->
        <div class="container my-4" id="ot-budget">
          <h3 class="mb-3">Budget de fonctionnement (OT)</h3>
          <div class="row g-3 mb-3">
            <div class="col-12 col-sm-6 col-lg-3">
              <div class="card shadow-sm h-100"><div class="card-body">
                <div class="small text-muted">OT chargés</div>
                <div class="fs-5 fw-semibold" id="otCount">–</div>
              </div></div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
              <div class="card shadow-sm h-100"><div class="card-body">
                <div class="small text-muted">Budget total</div>
                <div class="fs-5 fw-semibold" id="otSum">–</div>
              </div></div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
              <div class="card shadow-sm h-100"><div class="card-body">
                <div class="small text-muted" id="otYearLabel">Année en cours</div>
                <div class="fs-6" id="otPct">–</div>
              </div></div>
            </div>
          </div>
          <div class="d-flex gap-2 flex-wrap mb-2">
            <select id="otFilter" class="form-select" style="max-width:220px">
              <option value="">— Tous les OT —</option>
            </select>
            <input id="otSearch" class="form-control" placeholder="Rechercher objet de dépense…" style="max-width:320px"/>
          </div>
          <div class="table-responsive"><table class="table table-sm table-striped align-middle" id="otBudgetTable">
            <thead></thead>
            <tbody></tbody>
            <tfoot></tfoot>
          </table></div>
        </div>

        <div class="table-responsive">
          <table class="table table-striped align-middle" id="tblOT">
            <thead class="table-light">
              <tr>
                <th>N° OT</th><th>N° action</th><th>Désignation</th><th>Estimation</th>
                <th>Année 2025</th><th>Année 2026</th><th>Année 2027</th><th>Base d’estimation</th><th>N° commande</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- PPA (embedded Excel UI) -->
      <div id="tabLaunch" class="tab-pane fade">
        <div class="d-flex align-items-center mb-3">
          <h5 class="m-0">PPA — Données locales : <span id="ppaYear"></span></h5>
          <div class="ms-auto d-flex gap-2">
            <button id="btnSave" class="btn btn-primary btn-sm" disabled><i class="bi bi-save me-1"></i>Enregistrer</button>
            <div id="status" class="text-muted small ms-2"></div>
          </div>
        </div>

        <div id="accessCard" class="card shadow-sm mb-3">
          <div class="card-body">
            <h5 class="card-title mb-2"><i class="bi bi-folder2-open me-1"></i>Autoriser l'accès à <code>donnees.xlsx</code></h5>
            <p class="text-muted mb-3">Choisissez le dossier <code>data</code> ou déposez le fichier <code>donnees.xlsx</code>. Votre choix est <strong>mémorisé</strong> (IndexedDB) et restauré automatiquement.</p>
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <label class="btn btn-outline-secondary mb-0"><i class="bi bi-file-earmark-excel me-1"></i>Déposer/Choisir <code>donnees.xlsx</code>
                <input id="fileInput" type="file" accept=".xlsx" hidden>
              </label>
            </div>
            <div id="localFileFallback" style="display:none" class="mt-2">
              <div class="d-flex gap-2">
                <button id="btnLoadDefaultFiles" class="btn btn-outline-primary btn-sm">Charger les fichiers par défaut depuis le dossier <code>Data/</code></button>
                <button id="btnUseSampleData" class="btn btn-outline-secondary btn-sm">Utiliser des données d'exemple</button>
              </div>
              <input id="defaultFilesInput" type="file" accept=".xlsx" multiple style="display:none">
              <div id="localFallbackStatus" class="small text-muted mt-1"></div>
            </div>
          </div>
        </div>

        <div class="row g-2 align-items-end mb-2">
          <div class="col-md-3">
            <label class="form-label small">Catégorie dossier</label>
            <select id="fCategorie" class="form-select">
              <option value="">— Toutes —</option>
              <option>Nouveau dossier</option><option>Non lancé</option><option>Non Ouvert</option>
              <option>Ouvert</option><option>Marché chez RA</option><option>Marché Non Notifié</option>
              <option>Engagement notifié</option><option>Marché/Contrat en réalisation</option>
              <option>RP globale</option><option>Dossier clôturé</option><option>Dossier classé</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label small">N° OT</label>
            <select id="fOt" class="form-select"><option value="">— Tous —</option></select>
          </div>
          <div class="col-md-2">
            <label class="form-label small">N° Action</label>
            <select id="fAction" class="form-select"><option value="">— Toutes —</option></select>
          </div>
          <div class="col-md-2">
            <label class="form-label small">Année</label>
            <select id="fAnnee" class="form-select"><option value="">— Toutes —</option><option>2025</option><option>2026</option><option>2027</option></select>
          </div>
          <div class="col-md-3">
            <label class="form-label small">Recherche</label>
            <input id="fSearch" class="form-control" placeholder="Objet, contractant, pilote…">
          </div>
        </div>
        <div class="d-flex justify-content-end mb-3"><button id="btnReset" class="btn btn-outline-secondary btn-sm">Réinitialiser</button></div>

        <div class="table-responsive shadow-sm">
          <table class="table table-striped align-middle" id="dossiersTable">
            <thead class="table-light">
              <tr>
                <th>Ref PPA</th><th>Objet</th><th>Catégorie</th><th>Pilote</th><th>N° Action</th>
                <th>Date limite</th><th>N° OT</th><th>Contractant</th><th>ODS</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div>
  </section>
</main>

<!-- Modal fiche détaillée -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailTitle">Fiche</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="detailContent"></div>
        <hr>
        <div>
          <h6>Pièces jointes</h6>
          <div id="pjList" class="list-group mb-2"></div>
          <div class="input-group">
            <input type="file" id="pjInput" class="form-control">
            <button class="btn btn-outline-primary" onclick="UI.addPJ()">Ajouter</button>
          </div>
          <div class="form-text">Les fichiers sont conservés dans votre navigateur (localStorage). En production, connectez ce module à un backend pour utiliser le dossier <code>/pj/</code>.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="src/script.js"></script>
<script src="src/excel.js"></script>

<!-- Auto-initialize embedded login (if present) -->
<script>
  (function(){
    try{
      if(window.App && App.Auth && typeof App.Auth.initLogin === 'function'){
        // If available, call immediately to attach handlers. If DOM isn't ready, the function is robust enough to handle it.
        try{ App.Auth.initLogin(); }catch(e){ /* ignore */ }
      } else {
        // fallback: ensure init is called once DOM is ready
        document.addEventListener('DOMContentLoaded', function(){ try{ if(window.App && App.Auth && typeof App.Auth.initLogin === 'function') App.Auth.initLogin(); }catch(e){ console.warn('Auth init failed', e); } });
      }
    }catch(e){ console.warn('Auth init failed', e); }
  })();
</script>

<div id="globalLoader" class="app-loader d-none" aria-hidden="true">
  <div class="app-loader__content text-center">
    <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
    <div class="loader-message mt-3">Chargement…</div>
  </div>
</div>

</body>
</html>
